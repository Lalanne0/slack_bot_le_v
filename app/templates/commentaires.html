<!-- app/templates/commentaires.html -->
{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">ğŸ“ Commentaires des masterclasses</h2>

<form method="get" class="row g-3 mb-4">
  <!-- Multi-choix des notes -->
  <div class="col-md-4">
    <label for="grades" class="form-label">Filtrer par note sur le contenu</label>
    <select id="grades" name="grades" class="form-select" multiple size="5" aria-label="Filtrer par note">
      {% for g in [1,2,3,4,5] %}
        <option value="{{ g }}" {% if g in selected_grades %}selected{% endif %}>{{ g }} â˜…</option>
      {% endfor %}
    </select>
    <div class="form-text">Par dÃ©faut : 1, 2, 3. Ctrl + clic pour sÃ©lectionner plusieurs notes.</div>
  </div>

  <!-- Slider longueur minimale -->
  <div class="col-md-4">
    <label for="min_words" class="form-label">Nombre minimum de mots</label>
    <div class="d-flex align-items-center gap-2">
      <input type="range" id="min_words" name="min_words" class="form-range"
             min="1" max="100" step="1" value="{{ min_words }}">
      <span id="minWordsBadge" class="badge text-bg-secondary">{{ min_words }}</span>
    </div>
  </div>

  <!-- Slider pÃ©riode (en jours) -->
  <div class="col-md-4">
    <label for="days" class="form-label">PÃ©riode Ã©tudiÃ©e (jours)</label>
    <div class="d-flex align-items-center gap-2">
      <input type="range" id="days" name="days" class="form-range"
             min="1" max="180" step="1" value="{{ days }}">
      <span id="daysBadge" class="badge text-bg-secondary">{{ days }}</span>
    </div>
  </div>

  <div class="col-12">
    <button type="submit" class="btn btn-primary">Appliquer les filtres</button>
    <a href="{{ url_for('main.commentaires') }}" class="btn btn-outline-secondary">RÃ©initialiser</a>
  </div>
</form>

{% set rows = comments_df.to_dict(orient='records') if comments_df is not none else [] %}
{% if rows and rows|length > 0 %}
  <div class="card">
    <ul class="list-group list-group-flush">
      {% for r in rows %}
        {% set meeting_link = 'https://nexus.datascientest.com/meeting/' ~ (r['Meeting ID'] or '') %}
        {% set user_link = 'https://nexus.datascientest.com/user/' ~ (r['User ID'] or '') %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>{{ r['Masterclass'] }}</strong><br>
              <small class="text-muted">
                {% if r['Meeting Start Date'] %}
                  <a href="{{ meeting_link }}" target="_blank" rel="noopener">
                    {{ r['Meeting Start Date'].date() }}
                  </a>
                {% else %}
                  â€”
                {% endif %}
                Â·
                {% if r['User Fullname'] %}
                  <a href="{{ user_link }}" target="_blank" rel="noopener">
                    {{ r['User Fullname'] }}
                  </a>
                {% else %}
                  Utilisateur inconnu
                {% endif %}
                Â· ğŸ‘¨â€ğŸ« {{ r['Meeting Animator'] or 'â€”' }}
              </small>
            </div>
            <div class="ms-3">
              â­ {{ r['Content Grade'] if r['Content Grade'] is not none else 'â€”' }}/5
            </div>
          </div>

          {% if r['Comment'] %}
            <div class="mt-2"><em>{{ r['Comment'] }}</em></div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
{% else %}
  <div class="alert alert-info">Aucun commentaire pour les filtres sÃ©lectionnÃ©s.</div>
{% endif %}

<p class="mt-4">
  <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">â† Retour au dashboard</a>
</p>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const minWords = document.getElementById('min_words');
  const minWordsBadge = document.getElementById('minWordsBadge');
  if (minWords) minWords.addEventListener('input', () => minWordsBadge.textContent = minWords.value);

  const days = document.getElementById('days');
  const daysBadge = document.getElementById('daysBadge');
  if (days) days.addEventListener('input', () => daysBadge.textContent = days.value);
});
</script>
{% endblock %}
